<html>
  <head>
    <title>OpenCV test</title>
    <style>
      #canvasOutput {
        border: 1px solid black;
      }
      /* display loading gif and hide webpage */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        background: rgba(255, 255, 255, 0.8) url('http://i.stack.imgur.com/FhHRx.gif') 50% 50% no-repeat;
      }

      /* prevent scrollbar from display during load */
      body.loading {
        overflow: hidden;
      }

      /* display the modal when loading class is added to body */
      body.loading .modal {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="modal"></div>

    <video id="videoInput" autoplay="true" play width="300" height="225"></video> <br />
    <canvas id="canvasOutput" autoplay="true" width="300" height="225"></canvas>

    <script async src="js/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <script type="text/javascript">
      let streaming = false;
      navigator.mediaDevices
        .getUserMedia({
          video: true,
          audio: false
        })
        .then(function(stream) {
          videoInput.srcObject = stream;
          videoInput.play();
          streaming = true;
        })
        .catch(function(err) {
          console.log('An error occured While accessing media! ' + err);
        });

      function onOpenCvReady() {
        document.body.classList.remove('loading');
        console.log('page loaded');

        let video = document.getElementById('videoInput');
        let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
        let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
        let cap = new cv.VideoCapture(video);

        const FPS = 30;
        function processVideo() {
          try {
            if (!streaming) {
              // clean and stop.
              src.delete();
              dst.delete();
              return;
            }
            let begin = Date.now();
            // start processing.
            cap.read(src);
            cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
            cv.imshow('canvasOutput', dst);
            // schedule the next one.
            let delay = 1000 / FPS - (Date.now() - begin);
            setTimeout(processVideo, delay);
          } catch (err) {
            //   utils.printError(err);
            console.error(err);
          }
        }

        // schedule the first one.
        setTimeout(processVideo, 0);
      }
    </script>
  </body>
</html>
