<html>
  <head>
    <title>OpenCV test</title>
    <style>
      #canvasOutput {
        border: 1px solid black;
      }
      /* display loading gif and hide webpage */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        background: rgba(255, 255, 255, 0.8) url('http://i.stack.imgur.com/FhHRx.gif') 50% 50% no-repeat;
      }

      /* prevent scrollbar from display during load */
      body.loading {
        overflow: hidden;
      }

      /* display the modal when loading class is added to body */
      body.loading .modal {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="modal"></div>

    <video id="videoInput" autoplay="true" play width="300" height="225"></video> <br />
    <canvas id="canvasOutput" autoplay="true" width="300" height="225"></canvas>

    <script async src="js/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <script src="js/utils.js"></script>
    <script type="text/javascript">
      let streaming = false;
      navigator.mediaDevices
        .getUserMedia({
          video: true,
          audio: false
        })
        .then(function(stream) {
          videoInput.srcObject = stream;
          videoInput.play();
          streaming = true;
        })
        .catch(function(err) {
          console.log('An error occured While accessing media! ' + err);
        });

      function onOpenCvReady() {
        document.body.classList.remove('loading');
        console.log('page loaded');

        let video = document.getElementById('videoInput');
        let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
        let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
        // let cap = new cv.VideoCapture(video);
        let gray = new cv.Mat();
        let cap = new cv.VideoCapture(video);
        let faces = new cv.RectVector();
        let classifier = new cv.CascadeClassifier(); // initialize classifier

        // Note: Grab classifiers from github repo: https://github.com/opencv/opencv/tree/master/data/haarcascades
        let faceCascadeFile = 'haarcascade_frontalface_default.xml'; // path to xml
        // let faceCascadeFile = 'classifiers/haarcascade_frontalface_alt2.xml'; // path to xml
        // let faceCascadeFile = 'classifiers/haarcascade_eye_tree_eyeglasses.xml'; // path to xml

        // use createFileFromUrl to "pre-build" the xml
        createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {
          console.log('classifier loaded');
          classifier.load(faceCascadeFile); // in the callback, load the cascade from file
          setTimeout(processVideo, 0);
        });

        const FPS = 30;
        function processVideo() {
          try {
            if (!streaming) {
              // clean and stop.
              src.delete();
              dst.delete();
              gray.delete();
              faces.delete();
              classifier.delete();
              return;
            }
            let begin = Date.now();
            // start processing.
            cap.read(src);
            src.copyTo(dst);
            cv.cvtColor(dst, gray, cv.COLOR_RGBA2GRAY, 0);
            // detect faces.
            classifier.detectMultiScale(gray, faces, 1.1, 3, 0);

            // draw faces.
            for (let i = 0; i < faces.size(); ++i) {
              let face = faces.get(i);
              let point1 = new cv.Point(face.x, face.y);
              let point2 = new cv.Point(face.x + face.width, face.y + face.height);
              cv.rectangle(dst, point1, point2, [255, 0, 0, 255]);
            }
            cv.imshow('canvasOutput', dst);
            // schedule the next one.
            let delay = 1000 / FPS - (Date.now() - begin);
            setTimeout(processVideo, delay);
          } catch (err) {
            //   utils.printError(err);
            console.error(err);
          }
        }

        // schedule the first one.
        // setTimeout(processVideo, 0);
      }
    </script>
  </body>
</html>
